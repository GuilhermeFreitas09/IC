---
title: "Relatorio Parcial"
---


```{r}
#BiocManager::install("IlluminaHumanMethylationEPICanno.ilm10b4.hg19")
#BiocManager::install("missMethyl")

```

```{r,message=FALSE,warning=FALSE}
library(limma)
library(minfi)
library(IlluminaHumanMethylationEPICmanifest)
library(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
library(RColorBrewer)
library(readr)
#tidyverse::tidyverse_packages()
```

# Carregando os dados

```{r}
load("../../dados/rgSetSample.rds")
```

```{r}
dim(rgSet)
```

# Passo a passo do Cross Package

## Banco de dados dados amostrado

```{r}
#annEPIC <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
#dim(annEPIC)
```
46 informações de 865859 ilhas.

```{r}
sampleNames(rgSet)
```
Cada uma dessas amostras apresenta os arquivos green e red

```{r}
rgSet
```

## Controle de qualidade

```{r}
detP <- data.frame(detectionP(rgSet))
write_csv(detP, "../../dados/pvalor.csv")
```

```{r}
detP = read.csv(file = "../../dados/pvalor.csv")
```

```{r}
barplot(colMeans(detP), las=2, cex.names=0.5, ylim=c(0,0.0006))
abline(h=0.0005,col="red")
```
Legenda do gráfico: Média dos p-valores detectados nas CpG's para cada indivíduo.

### Removendo as amostras com qualidade baixa

```{r}
keep <- colMeans(detP) < 0.05
```

<!-- Manter no rgset -->

```{r}
rgSet <- rgSet[,keep]
```

<!-- Manter no detP -->

```{r}
detP <- detP[,keep]
```

## Normalização

```{r, eval=FALSE}
mSetSq <- preprocessQuantile(rgSet)
```

```{r, eval=FALSE}
save(mSetSq,file="../../dados/mSetSq.rds")
```

```{r}
load("../../dados/mSetSq.rds")
```

```{r}
dim(mSetSq)
```

```{r,fig.width=15}
par(mfrow=c(2,1))
densityPlot(rgSet,main="Dados Brutos", legend=FALSE)
densityPlot(getBeta(mSetSq),main="Dados Pré-processados", legend=FALSE)
```

```{r, fig.width=15}
par(mfrow=c(1,2))
boxplot(getBeta(rgSet),main="Dados Brutos", legend=FALSE)
boxplot(getBeta(mSetSq),main="Dados Pré-processados", legend=FALSE)
```

## Exploração de dados

```{r}
plotMDS(getM(mSetSq), top=1000, gene.selection="common")
```

## Filtragem

<!-- Filtragem das sondas problemáticas -->

```{r}
detP <- detP[match(featureNames(mSetSq),rownames(detP)),]
```

```{r}
keep <- rowSums(detP < 0.01) == ncol(mSetSq)
table(keep)
```

```{r}
remove(mSetSq)
```

```{r}
mSetSqFlt <- mSetSq[keep,]
```

<!-- Filtragem das probes dos cromossomos de sexo -->

```{r}
keep <- !(featureNames(mSetSqFlt) %in% ann450k$Name[ann450k$chr %in%
c("chrX","chrY")])
table(keep)
```

```{r}
mSetSqFlt <- mSetSqFlt[keep,]
```

<!-- Remove as sondas com SNP nos campos de CpG -->

```{r}
mSetSqFlt <- dropLociWithSnps(mSetSqFlt)
mSetSqFlt
```

<!-- excluir sondas de reatividade cruzada
```{r}
# NÃO CONSEGUI ACHAR ESTE ARQUIVO
xReactiveProbes <- read.csv(file=paste(dataDirectory,
"48639-non-specific-probes-Illumina450k.csv", sep="/"), stringsAsFactors=FALSE)

keep <- !(featureNames(mSetSqFlt) %in% xReactiveProbes$TargetID)
table(keep)
```
```{r}
mSetSqFlt <- mSetSqFlt[keep,]
```
-->

<!-- Salvando os dados finais após todos os filtros -->

```{r}
save(mSetSqFlt,file="../../dados/mSetSqFlt.rds")
```

```{r}
load("../../dados/mSetSqFlt.rds")
```

<!-- Cálculo de M e Beta -->

```{r}
mVals <- getM(mSetSqFlt)
```

```{r}
bVals <- getBeta(mSetSqFlt)
```

```{r}
head(mVals[,1:5])
head(bVals[,1:5])
```









